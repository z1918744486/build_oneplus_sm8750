name: Build_oneplus_sm8750
on:
  workflow_dispatch:
    inputs:
      DEVICES_NAME:
        description: "üìùËØ∑ÈÄâÊã©Ë¶ÅÁºñËØëÁöÑÊú∫ÂûãÔºö"
        required: true
        type: choice
        options:
          - 'oneplus_13'
          - 'oneplus_ace5_pro'
          - 'oneplus_13t'
          - 'oneplus_pad_2_pro'
          - 'oneplus_ace5_ultra'
          - 'realme_GT7'
          - 'realme_GT7pro'
          - 'realme_GT7pro_Speed'
        default: 'oneplus_ace5_pro'

      keep_original_settings:
        description: "üìù‰øùÊåÅÂéüÂÜÖÊ†∏ÂêçÁß∞ÂèäÊûÑÂª∫Êó∂Èó¥(‰∏çÊáÇËØ∑‰øùÊåÅÈªòËÆ§)"
        required: false
        default: true
        type: boolean

      custom_kernel_suffix:
        description: "‚úèÔ∏è Ëá™ÂÆö‰πâÂÜÖÊ†∏ÂêçÁß∞- ‰ªÖÂú®ÂèñÊ∂àÂãæÈÄâ'‰øùÊåÅÂéüËÆæÁΩÆ'Êó∂ÊúâÊïà(‰∏çÊáÇËØ∑‰øùÊåÅÈªòËÆ§)"
        required: false
        default: ''
      
      custom_kernel_time:
        description: "‚è∞ Ëá™ÂÆö‰πâÊûÑÂª∫Êó∂Èó¥- ‰ªÖÂú®ÂèñÊ∂àÂãæÈÄâ'‰øùÊåÅÂéüËÆæÁΩÆ'Êó∂ÊúâÊïà(‰∏çÊáÇËØ∑‰øùÊåÅÈªòËÆ§)"
        required: false
        default: ''

      enable_feature_z:
        description: "Ê∑ªÂä†ÂÆåÁæéÈ£éÈ©∞"
        required: false
        default: true
        type: boolean

      enable_feature_a:
        description: "ÂºÄÂêØBBGÂü∫Â∏¶ÂÆàÊä§"
        required: false
        default: true
        type: boolean

      enable_feature_b:
         description: "ÈÄâÊã©ÁΩëÁªúË∞ÉÂ∫¶"
         required: false
         type: choice
         options:
            - 'FQ_CODEL'
            - 'BBR'
         default: 'FQ_CODEL'
      
       


jobs:
  build:
    name: Build_${{ github.event.inputs.DEVICES_NAME }}
    runs-on: ubuntu-latest
    env:
      DEVICES_NAME:          ${{ github.event.inputs.DEVICES_NAME }}
      KEEP_ORIGINAL_SETTINGS: ${{ github.event.inputs.keep_original_settings }}
      CUSTOM_KERNEL_SUFFIX:   ${{ github.event.inputs.custom_kernel_suffix }}
      CUSTOM_KERNEL_TIME:     ${{ github.event.inputs.custom_kernel_time }}
      ENABLE_FEATURE_Z:       ${{ github.event.inputs.enable_feature_z }}
      ENABLE_FEATURE_A:       ${{ github.event.inputs.enable_feature_a }}
      ENABLE_FEATURE_B:       ${{ github.event.inputs.enable_feature_b }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: ‚öôÔ∏è Set REPO_MANIFEST (ËÆæÁΩÆÂØπÂ∫îÊú∫ÂûãÈÖçÁΩÆÊñá‰ª∂)
        run: |
          case "${{ env.DEVICES_NAME }}" in
            oneplus_ace5_pro)
              echo "REPO_MANIFEST=oneplus_ace5_pro_b" >> $GITHUB_ENV
              echo "SCHED_FILE=oneplus_ace5_pro_b" >> $GITHUB_ENV
              ;;
            oneplus_13)
              echo "REPO_MANIFEST=oneplus_13_b" >> $GITHUB_ENV
              echo "SCHED_FILE=oneplus_13_b" >> $GITHUB_ENV
              ;;
            oneplus_13t)
              echo "REPO_MANIFEST=oneplus_13t_b" >> $GITHUB_ENV
              echo "SCHED_FILE=oneplus_13t_b" >> $GITHUB_ENV
              ;;
            oneplus_pad_2_pro)
              echo "REPO_MANIFEST=oneplus_pad_2_pro_b" >> $GITHUB_ENV
              echo "SCHED_FILE=oneplus_pad_2_pro_b" >> $GITHUB_ENV
              ;;
            oneplus_ace5_ultra)
              echo "REPO_MANIFEST=oneplus_13_b" >> $GITHUB_ENV
              echo "SCHED_FILE=oneplus_13_b" >> $GITHUB_ENV
              ;;
            realme_GT7)
              echo "REPO_MANIFEST=oneplus_13_b" >> $GITHUB_ENV
              echo "SCHED_FILE=oneplus_13_b" >> $GITHUB_ENV
              ;;
            realme_GT7pro)
              echo "REPO_MANIFEST=oneplus_13_b" >> $GITHUB_ENV
              echo "SCHED_FILE=oneplus_13_b" >> $GITHUB_ENV
              ;;
            realme_GT7pro_Speed)
              echo "REPO_MANIFEST=oneplus_13_b" >> $GITHUB_ENV
              echo "SCHED_FILE=oneplus_13_b" >> $GITHUB_ENV
              ;;
          esac
          if [ "${{ env.KEEP_ORIGINAL_SETTINGS }}" = "false" ] && [ -n "${{ env.CUSTOM_KERNEL_SUFFIX }}" ]; then
            echo "‰ΩøÁî®Ëá™ÂÆö‰πâÂêçÁß∞: $custom_kernel_suffix"
            echo "DEFAULT_SUFFIX=$custom_kernel_suffix" >> $GITHUB_ENV
          else
          case "${{ env.DEVICES_NAME }}" in
            oneplus_pad_2_pro)
              echo 'DEFAULT_SUFFIX=-android15-8-g5a0ffb447c1d-ab13771415-4k' >> $GITHUB_ENV
              ;;
            oneplus_13)
              echo 'DEFAULT_SUFFIX=-android15-8-gf4dc45704e54-abogki446052083-4k' >> $GITHUB_ENV
              ;;
            realme_GT7)
              echo 'DEFAULT_SUFFIX=-android15-8-gd43086512890-abogki423825152-4k' >> $GITHUB_ENV
              ;;
            oneplus_ace5_pro | oneplus_13t | oneplus_ace5_ultra | realme_GT7pro_Speed | realme_GT7pro)
              echo 'DEFAULT_SUFFIX=-android15-8-g29d86c5fc9dd-abogki428889875-4k' >> $GITHUB_ENV
              ;;
          esac
          fi
          if [ "${{ env.KEEP_ORIGINAL_SETTINGS }}" = "false" ] && [ -n "${{ env.CUSTOM_KERNEL_TIME }}" ]; then
            echo "‰ΩøÁî®Ëá™ÂÆö‰πâÊûÑÂª∫Êó∂Èó¥: $CUSTOM_TIME"
            echo "KERNEL_TIME=$CUSTOM_TIME" >> $GITHUB_ENV
          else
            case "${{ env.DEVICES_NAME }}" in
              oneplus_pad_2_pro)
                echo 'KERNEL_TIME=Fri Jul 11 22:46:09 UTC 2025' >> $GITHUB_ENV
                ;;
              oneplus_13)
                echo 'KERNEL_TIME=Fri Sep 19 06:13:40 UTC 2025' >> $GITHUB_ENV
                ;;
              realme_GT7)
                echo 'KERNEL_TIME=Tue Jun 10 12:12:23 UTC 2025' >> $GITHUB_ENV
                ;;
              oneplus_ace5_pro | oneplus_13t | oneplus_ace5_ultra | realme_GT7pro_Speed | realme_GT7pro)
                echo 'KERNEL_TIME=Tue Jul  1 19:48:18 UTC 2025' >> $GITHUB_ENV
                ;;
            esac
          fi
          
      - name: üöÄ Maximize Build Space  (ÊúÄÂ§ßÂåñÊûÑÂª∫Á©∫Èó¥)
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 4096
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      - name: ‚öôÔ∏è Set device-specific CCACHE_DIR (ËÆæÁΩÆÂØπÂ∫îÊú∫ÂûãCcecheË∑ØÂæÑ)
        run: |
          echo "CCACHE_DIR=$HOME/.ccache_${REPO_MANIFEST}" >> $GITHUB_ENV

      - name: üì¶ Configure Git (ËÆæÁΩÆ‰∏ãËΩΩË¥¶Êà∑)
        run: |
          git config --global user.name "Q1udaoyu"
          git config --global user.email "sucisama2888@gmail.com"

      - name: üõ† Configure APT caching (ÈÖçÁΩÆAPTÁºìÂ≠ò)
        run: |
          APT_CACHE_DIR="$HOME/apt-cache"
          mkdir -p "$APT_CACHE_DIR"/{archives,lists/partial}
          echo "Dir::Cache \"$APT_CACHE_DIR\";" | sudo tee /etc/apt/apt.conf.d/90user-cache
          echo "Dir::Cache::archives \"$APT_CACHE_DIR/archives\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
          echo "Dir::State::lists \"$APT_CACHE_DIR/lists\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
          echo "Acquire::Check-Valid-Until \"false\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
          echo "Acquire::Languages \"none\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
          sudo chown -R $USER:$USER "$APT_CACHE_DIR"

      - name: üõ† Cache APT packages (ÁºìÂ≠òAPTÂåÖ)
        uses: actions/cache@v3
        with:
          path: ${{ env.HOME }}/apt-cache
          key: ${{ runner.os }}-apt-qiudaoyu
          restore-keys: |
            ${{ runner.os }}-apt-qiudaoyu

      - name: üì¶ Install dependencies (ÂÆâË£Ö‰æùËµñ)
        run: |
          sudo rm -f /var/lib/apt/lists/lock /var/lib/dpkg/lock
          APT_CACHE_DIR="$HOME/apt-cache"
          mkdir -p "$APT_CACHE_DIR/lists/partial"
          sudo apt -o Dir::Cache="$APT_CACHE_DIR" update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt -o Dir::Cache="$APT_CACHE_DIR" install -yq --no-install-recommends \
            python3 dos2unix p7zip-full git curl ccache libelf-dev \
            build-essential libelf-dev flex bison libssl-dev \
            libncurses-dev liblz4-tool zlib1g-dev \
            libxml2-utils rsync unzip
          
          echo "‚úÖ ‰æùËµñÂÆâË£ÖÂÆåÊàê"
          
      - name: üì• Restore ccache (ËΩΩÂÖ• Êú∫ÂûãÔºö${{ env.DEVICES_NAME }}ÁöÑ ccache ÁºìÂ≠ò)
        uses: actions/cache@v3
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ runner.os }}-${{ github.ref }}-${{ env.REPO_MANIFEST }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ env.DEVICES_NAME }}-
            ccache-${{ runner.os }}-

      - name: üì• Init ccache (Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÊ¨°ËøêË°åÂàôÂàùÂßãÂåñCceche)
        run: |
          export CCACHE_COMPILERCHECK="%compiler% -dumpmachine; %compiler% -dumpversion"
          export CCACHE_NOHASHDIR="true"
          export CCACHE_HARDLINK="true"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          export CCACHE_MAXSIZE="8G"

          INIT_FLAG="$CCACHE_DIR/.ccache_initialized"
          if command -v ccache >/dev/null 2>&1; then
            if [ ! -f "$INIT_FLAG" ]; then
              echo "ÂàùÂßãÂåñ ccache ($CCACHE_DIR)..."
              mkdir -p "$CCACHE_DIR"
              ccache -M "$CCACHE_MAXSIZE"
              touch "$INIT_FLAG"
            else
              echo "ccache Â∑≤ÂàùÂßãÂåñÔºåË∑≥Ëøá"
            fi
          else
            echo "Êú™ÂÆâË£Ö ccacheÔºåË∑≥Ëøá"
          fi


      - name: üì• Install repo tool (‰∏ãËΩΩrepoÂ∑•ÂÖ∑)
        run: |
         curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
         chmod a+x ~/repo
         sudo mv ~/repo /usr/local/bin/repo

      - name: üì• Initialize repo and sync (ÂàùÂßãÂåñrepoÂπ∂ÂêåÊ≠•ÂÜÖÊ†∏Ê∫êÁ†Å)
        run: |
         mkdir kernel_workspace && cd kernel_workspace
         repo init -u https://github.com/showdo/kernel_manifest.git -b refs/heads/oneplus/sm8750 -m ${REPO_MANIFEST}.xml --depth=1
         repo --trace sync -c -j$(nproc --all) --no-tags
         rm kernel_platform/common/android/abi_gki_protected_exports_* || echo "No protected exports!"
         rm kernel_platform/msm-kernel/android/abi_gki_protected_exports_* || echo "No protected exports!"
         
      - name: üîß apply lz4 1.10.0 & zstd 1.5.7 patches (Ê∑ªÂä†lz4 1.10.0 & zstd 1.5.7Ë°•‰∏Å)
        run: |
          echo "Ê≠£Âú®Ê∑ªÂä†lz4 1.10.0 & zstd 1.5.7Ë°•‰∏Å‚Ä¶"
          cd kernel_workspace
          git clone https://github.com/cctv18/oppo_oplus_realme_sm8750.git
          cp ./oppo_oplus_realme_sm8750/zram_patch/001-lz4.patch ./kernel_platform/common
          cp ./oppo_oplus_realme_sm8750/zram_patch/lz4armv8.S ./kernel_platform/common/lib
          cp ./oppo_oplus_realme_sm8750/zram_patch/002-zstd.patch ./kernel_platform/common/
          cd ./kernel_platform/common
          git apply -p1 < 001-lz4.patch || true
          patch -p1 < 002-zstd.patch || true
          
      - name: üîß Set Baseband-guard (ÂºÄÂêØBBGÂü∫Â∏¶ÂÆàÊä§)
        if: ${{ env.ENABLE_FEATURE_A }}
        run: |
          cd kernel_workspace/kernel_platform/common
          echo "Ê≠£Âú®ÂêØÁî®BBGÂü∫Â∏¶ÂÆàÊä§‚Ä¶"
          curl -LSs https://raw.githubusercontent.com/vc-teahouse/Baseband-guard/main/setup.sh | bash
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' ./security/Kconfig
          
      - name: ‚öôÔ∏è Set SuKiSU Ultra (ËÆæÁΩÆSuKiSU Ultra)
        run: |
          set -e
          cd kernel_workspace/kernel_platform
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" -o setup.sh
          bash setup.sh susfs-main
          cd KernelSU
          KSU_VERSION=$(expr "$(git rev-list --count main)" + 37185 2>/dev/null || echo 114514)
          echo "KSUVER=$KSU_VERSION" >> "$GITHUB_ENV"
          cp "${GITHUB_WORKSPACE}/.github/workflows/Bin/setup.bin" ./
          chmod +x setup.bin
          if [ ! -f "kernel/Makefile" ]; then
            echo "::error ::kernel/Makefile"
            ls -la
            exit 1
          fi
          ./setup.bin

            
      - name: üîß Set up SUSFS (ÈÖçÁΩÆ SUSFS)
        run: |
          cd kernel_workspace
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android15-6.6
          git clone https://github.com/SukiSU-Ultra/SukiSU_patch.git
          cd kernel_platform
          cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android15-6.6.patch common/
          cp ../susfs4ksu/kernel_patches/fs/* common/fs/
          cp ../susfs4ksu/kernel_patches/include/linux/* common/include/linux/
          if [ "$DEVICES_NAME" = "oneplus_ace5_ultra" ] \
            || [ "$DEVICES_NAME" = "realme_GT7" ] \
            || [ "$DEVICES_NAME" = "realme_GT7pro" ] \
            || [ "$DEVICES_NAME" = "realme_GT7pro_Speed" ]; then
            sed -i 's/^\(SUBLEVEL[[:space:]]*=[[:space:]]*\).*/\166/' common/Makefile
          fi
          ( cd common && patch -p1 < 50_add_susfs_in_gki-android15-6.6.patch ) || true
          cp ../SukiSU_patch/hooks/scope_min_manual_hooks_v1.6.patch common/
          ( cd common && patch -p1 -F 3 < scope_min_manual_hooks_v1.6.patch )
          echo "SUSFS ÈÖçÁΩÆÂÆåÊàê"



          
      - name: üîß Set gki_defconfig (ËÆæÁΩÆÁºñËØëÈÖçÁΩÆ) 
        run: |
          cd kernel_workspace/kernel_platform
          echo "CONFIG_KSU=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_MANUAL_HOOK=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KPM=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_CRYPTO_LZ4=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_CRYPTO_LZ4HC=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_CRYPTO_LZ4KD=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_CRYPTO_ZSTD=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_F2FS_FS_COMPRESSION=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_F2FS_FS_LZ4=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_F2FS_FS_LZ4HC=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_F2FS_FS_ZSTD=y" >> ./common/arch/arm64/configs/gki_defconfig

          if [ "${{ env.ENABLE_B }}" = "BBR" ]; then
            echo "CONFIG_TCP_CONG_ADVANCED=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_BBR=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NET_SCH_FQ=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_BIC=n" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_CUBIC=n" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_WESTWOOD=n" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_HTCP=n" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_DEFAULT_TCP_CONG=bbr" >> ./common/arch/arm64/configs/gki_defconfig
          fi
          if [ "${{ env.ENABLE_B }}" = "FQ_CODEL" ]; then
            echo "CONFIG_NET_SCH_FQ_CODEL=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NET_SCH_FQ=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NET_SCH_SFQ=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NET_SCH_HTB=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NET_SCH_TBF=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NET_SCH_SFB=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NET_SCH_RED=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NET_SCH_INGRESS=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_DEFAULT_FQ_CODEL=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo 'CONFIG_DEFAULT_NET_SCH="fq_codel"' >> ./common/arch/arm64/configs/gki_defconfig
          fi
          echo "CONFIG_IP_ECN=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_TCP_ECN=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IPV6_ECN=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_NF_TARGET_ECN=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_TMPFS_XATTR=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_TMPFS=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_HEADERS_INSTALL=n" >> ./common/arch/arm64/configs/gki_defconfig
          #Remove check_defconfig
          sudo sed -i 's/check_defconfig//' ./common/build.config.gki

      - name: üîß Set Kernel name (ËÆæÁΩÆÂÜÖÊ†∏ÂêçÁß∞)
        run: |
          cd kernel_workspace/kernel_platform
          echo "ÂÜÖÊ†∏ÂêéÁºÄ: $DEFAULT_SUFFIX"
          ESCAPED_SUFFIX=$(printf '%s\n' "$DEFAULT_SUFFIX" | sed 's:[\/&]:\\&:g')
          sudo sed -i "s/-4k/$ESCAPED_SUFFIX/g" ./common/arch/arm64/configs/gki_defconfig
          sed -i 's/${scm_version}//' ./common/scripts/setlocalversion
          
      - name: üîß Apply Sched Patch (Â∫îÁî®ÂÆåÁæéÈ£éÈ©∞Ë°•‰∏Å)
        run: |
          cd kernel_workspace/kernel_platform/common
          fix_ksu_devpts_stub() {
            local file="fs/devpts/inode.c"
            if grep -q "int ksu_handle_devpts(struct inode \*inode)" "$file"; then
              echo "ksu_handle_devpts stub Â∑≤Â≠òÂú®ÔºåË∑≥Ëøá"
              return
            fi
            echo "‰∏∫ ksu_handle_devpts Ê≥®ÂÖ• stub ÂÆûÁé∞..."
            cat >> "$file" << 'EOF'
          int ksu_handle_devpts(struct inode *inode)
          {
                  return 0;
          }
          EOF
          }
          fix_ksu_devpts_stub
          if [ "${{ env.ENABLE_FEATURE_Z }}" = "true" ]; then
            git clone https://github.com/Numbersf/SCHED_PATCH.git -b "sm8750"
            echo "Ê≠£Âú®ÊãâÂèñÈ£éÈ©∞Ë°•‰∏Å"
            cp ./SCHED_PATCH/fengchi_${{env.SCHED_FILE}}.patch ./
            if [[ -f "fengchi_${{env.SCHED_FILE}}.patch" ]]; then
              echo "ÂºÄÂßãÂ∫îÁî®È£éÈ©∞Ë°•‰∏Å"
              dos2unix "fengchi_${{env.SCHED_FILE}}.patch"
              patch -p1 -F 3 < "fengchi_${{env.SCHED_FILE}}.patch"
              echo "ÂÆåÁæéÈ£éÈ©∞Ë°•‰∏ÅÂ∫îÁî®ÂÆåÊàê"
            else
              echo "‚ùå Êú™ÂåπÈÖçÂà∞Ë°•‰∏ÅÔºåÈ£éÈ©∞Ë°•‰∏ÅÊöÇÊú™ÊîØÊåÅËØ•Êú∫Âûã"
              exit 11
            fi
          else
            echo "Êú™ÂêØÁî®È£éÈ©∞ÔºåÂàôÈúÄÂ∫îÁî®OGKIËΩ¨Êç¢GKIË°•‰∏Å"
            sed -i '1iobj-y += hmbird_patch.o' drivers/Makefile
             cp "${GITHUB_WORKSPACE}/.github/workflows/Bin/hmbird_patch.patch" ./hmbird_patch.patch
            echo "Ê≠£Âú®ÊâìOGKIËΩ¨Êç¢GKIË°•‰∏Å"
            patch -p1 -F 3 < hmbird_patch.patch
            echo "OGKIËΩ¨Êç¢GKI_patchÂÆåÊàê"
          fi

      - name: üî® Build Kernel (ÊûÑÂª∫ÂÜÖÊ†∏)
        run: |
          export PATH="/usr/lib/ccache:$GITHUB_WORKSPACE/kernel_workspace/kernel_platform/prebuilts/clang/host/linux-x86/clang-r510928/bin:$PATH"          
          export CCACHE_COMPILERCHECK="%compiler% -dumpmachine; %compiler% -dumpversion"
          export CCACHE_NOHASHDIR="true"
          export CCACHE_HARDLINK="true"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          export CCACHE_MAXSIZE="8G"
          export KBUILD_BUILD_TIMESTAMP="${KERNEL_TIME}"
          cd kernel_workspace/kernel_platform/common
          make -j$(nproc --all) LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC="ccache clang" RUSTC=../../prebuilts/rust/linux-x86/1.73.0b/bin/rustc PAHOLE=../../prebuilts/kernel-build-tools/linux-x86/bin/pahole LD=ld.lld HOSTLD=ld.lld O=out KCFLAGS+=-O2  gki_defconfig
          make -j$(nproc --all) LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC="ccache clang" RUSTC=../../prebuilts/rust/linux-x86/1.73.0b/bin/rustc PAHOLE=../../prebuilts/kernel-build-tools/linux-x86/bin/pahole LD=ld.lld HOSTLD=ld.lld O=out KCFLAGS+=-O2  Image
       
      - name: üì¶ Make AnyKernel3 (ÂàõÂª∫Anykernel3)
        run: |
          cp "${GITHUB_WORKSPACE}/.github/workflows/Bin/main.bin" ./
          chmod +x main.bin
          ./main.bin "make_anykernel3"
          rm -rf ./main.bin
          
      - name: üì§ Upload AnyKernel3 (‰∏ä‰º† Anykernel3)
        uses: actions/upload-artifact@v4
        with:
         name: AK3_${{ env.KSUVER }}_${{ env.DEVICES_NAME }}_SuKiSU
         path: ./AnyKernel3/*
